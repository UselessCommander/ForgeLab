<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Kode Dashboard - Statistik</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header h1 {
            color: #333;
            font-size: 2em;
        }

        .header .stats-summary {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            min-width: 120px;
        }

        .stat-box .number {
            font-size: 2em;
            font-weight: bold;
        }

        .stat-box .label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }

        .qr-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .qr-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .qr-card:hover {
            transform: translateY(-5px);
        }

        .qr-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .qr-card-header h3 {
            color: #333;
            font-size: 1.2em;
        }

        .qr-id {
            font-family: monospace;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            color: #666;
        }

        .qr-stats {
            margin-bottom: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #666;
            font-weight: 600;
        }

        .stat-value {
            color: #333;
            font-weight: bold;
        }

        .scan-count {
            font-size: 2em;
            color: #667eea;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 10px 0;
        }

        .qr-url {
            word-break: break-all;
            color: #667eea;
            font-size: 0.9em;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .empty-state {
            background: white;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .empty-state h2 {
            color: #666;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auto-refresh input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .link-home {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            padding: 10px 15px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .link-home:hover {
            background: #f0f0f0;
        }

        .updating {
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .stat-box.updating {
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üìä QR Kode Dashboard</h1>
                <p style="color: #666; margin-top: 5px;">Oversigt over alle QR-koder og scanninger</p>
            </div>
            <div class="stats-summary">
                <div class="stat-box">
                    <div class="number" id="totalQRCodes">0</div>
                    <div class="label">QR Koder</div>
                </div>
                <div class="stat-box">
                    <div class="number" id="totalScans">0</div>
                    <div class="label">Total Scanninger</div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button onclick="refreshData()">üîÑ Opdater</button>
            <button class="btn-secondary" onclick="window.location.href='/'">üè† Tilbage til Generator</button>
            <button class="btn-secondary" onclick="testAPI()" style="font-size: 0.9em; padding: 8px 15px;">üß™ Test API</button>
            <button class="btn-secondary" onclick="checkServerStatus()" style="font-size: 0.9em; padding: 8px 15px;">üîç Tjek Server</button>
            <button class="btn-danger" onclick="deleteAllQR()" style="font-size: 0.9em; padding: 8px 15px;">üóëÔ∏è Slet Alle</button>
            <div class="auto-refresh">
                <input type="checkbox" id="autoRefresh" checked onchange="toggleAutoRefresh()">
                <label for="autoRefresh" style="color: #333; cursor: pointer;">Auto-opdater (hver 3 sek)</label>
            </div>
            <div id="lastUpdate" style="color: #666; font-size: 0.9em; margin-left: auto;">
                Sidst opdateret: <span id="lastUpdateTime">-</span>
                <span id="updateIndicator" style="margin-left: 10px; display: none;">üîÑ Opdaterer...</span>
            </div>
        </div>

        <div id="loading" class="loading">Indl√¶ser data...</div>
        <div id="qrList" class="qr-list" style="display: none;"></div>
        <div id="emptyState" class="empty-state" style="display: none;">
            <h2>Ingen QR-koder endnu</h2>
            <p>Generer din f√∏rste QR-kode med tracking for at se statistikker her.</p>
            <button onclick="window.location.href='/'" style="margin-top: 20px;">G√• til Generator</button>
        </div>
    </div>

    <script>
        // Auto-detect API URL based on current domain
        const API_URL = (function() {
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            
            // Production domain
            if (hostname === 'qr.floweffekt.dk' || hostname.includes('vercel.app')) {
                return `${protocol}//${hostname}`;
            }
            // Local development
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:3000';
            }
            // Local network (IP address)
            return `${protocol}//${hostname}${window.location.port ? ':' + window.location.port : ''}`;
        })();
        console.log('API URL:', API_URL);
        let autoRefreshInterval = null;
        let data = {}; // Store current data globally for delete functions

        async function loadData() {
            try {
                // Show update indicator
                const updateIndicator = document.getElementById('updateIndicator');
                if (updateIndicator) {
                    updateIndicator.style.display = 'inline';
                }
                
                // Add updating class to show visual feedback
                const statBoxes = document.querySelectorAll('.stat-box');
                statBoxes.forEach(box => box.classList.add('updating'));
                
                const response = await fetch(`${API_URL}/api/stats`, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const responseData = await response.json();
                data = responseData; // Store globally for delete functions
                console.log('‚úÖ Data modtaget fra API:', data);
                console.log('üìä Antal QR-koder:', Object.keys(data).length);
                
                // Log total scanninger
                let totalScans = 0;
                Object.keys(data).forEach(qrId => {
                    totalScans += data[qrId].count || 0;
                });
                console.log('üî¢ Total scanninger:', totalScans);
                
                displayData(data);
                updateLastUpdateTime();
                
                // Remove updating class and indicator
                statBoxes.forEach(box => box.classList.remove('updating'));
                if (updateIndicator) {
                    updateIndicator.style.display = 'none';
                }
            } catch (error) {
                console.error('Fejl ved indl√¶sning:', error);
                const loadingEl = document.getElementById('loading');
                if (loadingEl) {
                    loadingEl.innerHTML = 
                        `<div style="color: #dc3545;">Fejl ved indl√¶sning af data: ${error.message}<br>Tjek at serveren k√∏rer p√• ${API_URL}</div>`;
                }
                
                // Remove updating class and indicator on error
                const statBoxes = document.querySelectorAll('.stat-box');
                statBoxes.forEach(box => box.classList.remove('updating'));
                const updateIndicator = document.getElementById('updateIndicator');
                if (updateIndicator) {
                    updateIndicator.style.display = 'none';
                }
            }
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const adjustedTime = new Date(now.getTime() - 2 * 60 * 60 * 1000); // Subtract 2 hours
            const timeString = adjustedTime.toLocaleTimeString('da-DK');
            const lastUpdateEl = document.getElementById('lastUpdateTime');
            if (lastUpdateEl) {
                lastUpdateEl.textContent = timeString;
            }
        }

        function displayData(data) {
            console.log('displayData kaldt med:', data);
            const qrList = document.getElementById('qrList');
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('emptyState');
            
            if (loading) {
                loading.style.display = 'none';
            }

            // Check if data is valid
            if (!data || typeof data !== 'object') {
                console.error('Ugyldig data modtaget:', data);
                if (emptyState) {
                    emptyState.style.display = 'block';
                    emptyState.innerHTML = '<h2>Fejl</h2><p>Kunne ikke indl√¶se data korrekt.</p>';
                }
                if (qrList) {
                    qrList.style.display = 'none';
                }
                updateSummary(0, 0);
                return;
            }

            const qrCodes = Object.keys(data);
            console.log('QR-koder fundet:', qrCodes.length, qrCodes);
            
            if (qrCodes.length === 0) {
                console.log('Ingen QR-koder fundet');
                if (qrList) {
                    qrList.style.display = 'none';
                }
                if (emptyState) {
                    emptyState.style.display = 'block';
                }
                updateSummary(0, 0);
                return;
            }

            console.log('Viser QR-koder:', qrCodes.length);
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            if (qrList) {
                qrList.style.display = 'grid';
                qrList.innerHTML = '';
            }

            let totalScans = 0;

            qrCodes.forEach(qrId => {
                const qrData = data[qrId];
                console.log(`Behandler QR-kode ${qrId}:`, qrData);
                if (!qrData) {
                    console.warn(`Ingen data for QR-kode ${qrId}`);
                    return;
                }
                totalScans += qrData.count || 0;

                const card = document.createElement('div');
                card.className = 'qr-card';
                
                // Subtract 2 hours from createdAt for display
                const createdAt = qrData.createdAt ? (() => {
                    const date = new Date(qrData.createdAt);
                    date.setHours(date.getHours() - 2);
                    return date.toLocaleString('da-DK');
                })() : 'Ukendt';
                // Show lastScan in real time (no adjustment)
                const lastScan = qrData.scans && qrData.scans.length > 0 
                    ? new Date(qrData.scans[qrData.scans.length - 1].timestamp).toLocaleString('da-DK')
                    : 'Ingen scanninger endnu';

                card.innerHTML = `
                    <div class="qr-card-header">
                        <h3>QR Kode</h3>
                        <span class="qr-id">${qrId.substring(0, 12)}...</span>
                    </div>
                    <div class="scan-count">${qrData.count || 0}</div>
                    <div style="text-align: center; color: #666; margin-bottom: 15px;">scanninger</div>
                    <div class="qr-stats">
                        <div class="stat-item">
                            <span class="stat-label">Oprettet:</span>
                            <span class="stat-value">${createdAt}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Sidste scan:</span>
                            <span class="stat-value">${lastScan}</span>
                        </div>
                    </div>
                    ${qrData.originalUrl ? `
                        <div class="qr-url">
                            <strong>Original URL:</strong><br>
                            ${qrData.originalUrl}
                        </div>
                    ` : ''}
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="copyUrl('${qrId.replace(/'/g, "\\'")}')" style="flex: 1; min-width: 100px; font-size: 0.9em; padding: 8px;">üìã Kopier URL</button>
                        <button onclick="viewDetails('${qrId.replace(/'/g, "\\'")}')" class="btn-secondary" style="flex: 1; min-width: 100px; font-size: 0.9em; padding: 8px;">üìà Detaljer</button>
                        <button onclick="testDelete('${qrId.replace(/'/g, "\\'")}')" class="btn-secondary" style="flex: 1; min-width: 100px; font-size: 0.9em; padding: 8px;">üß™ Test Delete</button>
                        <button onclick="deleteQR('${qrId.replace(/'/g, "\\'")}')" class="btn-danger" style="flex: 1; min-width: 100px; font-size: 0.9em; padding: 8px;">üóëÔ∏è Slet</button>
                    </div>
                `;
                
                if (qrList) {
                    qrList.appendChild(card);
                }
            });

            console.log(`Opdaterer summary: ${qrCodes.length} QR-koder, ${totalScans} total scanninger`);
            updateSummary(qrCodes.length, totalScans);
        }

        function updateSummary(totalQRCodes, totalScans) {
            const totalQRCodesEl = document.getElementById('totalQRCodes');
            const totalScansEl = document.getElementById('totalScans');
            if (totalQRCodesEl) {
                totalQRCodesEl.textContent = totalQRCodes;
            }
            if (totalScansEl) {
                totalScansEl.textContent = totalScans;
            }
            console.log(`Summary opdateret: ${totalQRCodes} QR-koder, ${totalScans} scanninger`);
        }

        async function refreshData() {
            // Don't show loading or hide content if auto-refreshing (to avoid flickering)
            const isAutoRefresh = autoRefreshInterval !== null;
            const loadingEl = document.getElementById('loading');
            const qrListEl = document.getElementById('qrList');
            const emptyStateEl = document.getElementById('emptyState');
            
            // Only show loading/hide content on manual refresh
            if (!isAutoRefresh) {
                if (loadingEl) {
                    loadingEl.style.display = 'block';
                }
                if (qrListEl && qrListEl.style.display !== 'none') {
                    qrListEl.style.display = 'none';
                }
                if (emptyStateEl && emptyStateEl.style.display !== 'none') {
                    emptyStateEl.style.display = 'none';
                }
            }
            
            await loadData();
        }

        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            if (checkbox.checked) {
                // Clear any existing interval
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                }
                // Start new interval (every 3 seconds for faster updates)
                autoRefreshInterval = setInterval(() => {
                    console.log('Auto-opdatering: Opdaterer data...');
                    refreshData();
                }, 3000);
                console.log('‚úÖ Auto-opdatering aktiveret (hver 3 sek)');
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                console.log('‚è∏Ô∏è Auto-opdatering deaktiveret');
            }
        }

        function copyUrl(qrId) {
            const url = `${API_URL}/track/${qrId}`;
            navigator.clipboard.writeText(url).then(() => {
                alert('URL kopieret til udklipsholder!');
            }).catch(() => {
                prompt('Kopi√©r denne URL:', url);
            });
        }

        function viewDetails(qrId) {
            window.open(`${API_URL}/api/stats/${qrId}`, '_blank');
        }

        async function testDelete(qrId) {
            console.log('üß™ Tester DELETE for QR ID:', qrId);
            console.log('API_URL:', API_URL);
            const testUrl = `${API_URL}/api/stats/${qrId}`;
            console.log('Test URL:', testUrl);
            
            try {
                const response = await fetch(testUrl, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                console.log('Test DELETE response status:', response.status);
                console.log('Test DELETE response ok:', response.ok);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Test DELETE result:', result);
                    alert(`‚úÖ DELETE test succesfuld!\n\nStatus: ${response.status}\nResult: ${JSON.stringify(result, null, 2)}\n\nSe konsol for detaljer.`);
                } else {
                    const errorText = await response.text();
                    console.error('Test DELETE fejl:', errorText);
                    alert(`‚ùå DELETE test fejlede!\n\nStatus: ${response.status}\nFejl: ${errorText}\n\nSe konsol for detaljer.`);
                }
            } catch (error) {
                console.error('Test DELETE exception:', error);
                alert(`‚ùå DELETE test exception!\n\nFejl: ${error.message}\n\nSe konsol for detaljer.`);
            }
        }

        async function deleteQR(qrId) {
            console.log('üóëÔ∏è deleteQR kaldt med qrId:', qrId);
            console.log('API_URL:', API_URL);
            
            // Get current data if not already loaded
            if (!data || Object.keys(data).length === 0) {
                console.log('Henter data f√∏r sletning...');
                try {
                    const response = await fetch(`${API_URL}/api/stats`);
                    if (response.ok) {
                        data = await response.json();
                        console.log('Data hentet:', data);
                    } else {
                        console.error('Kunne ikke hente data, status:', response.status);
                    }
                } catch (error) {
                    console.error('Kunne ikke hente data:', error);
                }
            }

            const qrData = data[qrId];
            console.log('QR data for sletning:', qrData);
            
            if (!qrData) {
                alert(`‚ùå QR-kode ikke fundet i data!\n\nID: ${qrId}\n\nPr√∏v at opdatere siden f√∏rst.`);
                return;
            }

            const qrUrl = qrData?.originalUrl || 'Ingen URL';
            const scanCount = qrData?.count || 0;
            
            if (!confirm(`Er du sikker p√• at du vil slette denne QR-kode?\n\nID: ${qrId.substring(0, 12)}...\nURL: ${qrUrl}\nScanninger: ${scanCount}\n\nDette kan ikke fortrydes!`)) {
                console.log('Sletning annulleret af bruger');
                return;
            }

            try {
                console.log(`üóëÔ∏è Sletter QR-kode: ${qrId}`);
                console.log(`üìç DELETE URL: ${API_URL}/api/stats/${qrId}`);
                
                // Stop auto-refresh temporarily
                const wasAutoRefreshing = autoRefreshInterval !== null;
                if (wasAutoRefreshing) {
                    console.log('Pauserer auto-refresh');
                    toggleAutoRefresh(); // Turn off
                }
                
                const deleteUrl = `${API_URL}/api/stats/${qrId}`;
                console.log('Sender DELETE request til:', deleteUrl);
                
                const response = await fetch(deleteUrl, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    mode: 'cors'
                });

                console.log('Delete response status:', response.status);
                console.log('Delete response ok:', response.ok);
                console.log('Delete response headers:', [...response.headers.entries()]);

                if (!response.ok) {
                    let errorText = '';
                    try {
                        errorText = await response.text();
                    } catch (e) {
                        errorText = 'Kunne ikke l√¶se fejlbesked';
                    }
                    console.error('Delete fejl response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}\n${errorText}`);
                }

                let result;
                try {
                    result = await response.json();
                } catch (e) {
                    // Hvis response ikke er JSON, pr√∏v som tekst
                    const text = await response.text();
                    console.log('Response tekst:', text);
                    result = { success: true, message: text };
                }
                
                console.log('‚úÖ QR-kode slettet:', result);
                
                // Remove from local data immediately
                if (data[qrId]) {
                    delete data[qrId];
                    console.log('Fjernet fra lokal data');
                }
                
                // Refresh data to update the display
                console.log('Opdaterer display...');
                await refreshData();
                
                // Restart auto-refresh if it was on
                if (wasAutoRefreshing) {
                    setTimeout(() => {
                        console.log('Genstarter auto-refresh');
                        toggleAutoRefresh();
                    }, 500);
                }
                
                // Show success message
                alert('‚úÖ QR-kode slettet!');
            } catch (error) {
                console.error('‚ùå Fejl ved sletning:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                
                let errorMsg = error.message;
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMsg = `Kunne ikke forbinde til serveren.\n\nTjek at serveren k√∏rer p√•:\n${API_URL}\n\nFejl: ${error.message}`;
                }
                
                alert(`‚ùå Fejl ved sletning:\n\n${errorMsg}\n\nTjek browser konsol (F12) og server konsol for detaljer.`);
            }
        }

        async function deleteAllQR() {
            // Get current data if not already loaded
            if (!data || Object.keys(data).length === 0) {
                try {
                    const response = await fetch(`${API_URL}/api/stats`);
                    if (response.ok) {
                        data = await response.json();
                    }
                } catch (error) {
                    console.error('Kunne ikke hente data:', error);
                }
            }

            const qrCount = Object.keys(data || {}).length;
            
            if (qrCount === 0) {
                alert('Der er ingen QR-koder at slette.');
                return;
            }

            // Calculate total scans
            let totalScans = 0;
            Object.keys(data).forEach(qrId => {
                totalScans += data[qrId].count || 0;
            });

            if (!confirm(`‚ö†Ô∏è ADVARSEL!\n\nEr du sikker p√• at du vil slette ALLE ${qrCount} QR-koder?\n\nTotal scanninger der vil blive mistet: ${totalScans}\n\nDette kan IKKE fortrydes!\n\nAlle statistikker og scanninger vil blive mistet permanent!`)) {
                return;
            }

            // Double confirmation
            if (!confirm(`‚ö†Ô∏è SIDSTE BEKR√ÜFTELSE!\n\nEr du HELT sikker?\n\nDette vil slette ALT data permanent!\n\n${qrCount} QR-koder\n${totalScans} scanninger\n\nDette kan IKKE fortrydes!`)) {
                return;
            }

            try {
                console.log('üóëÔ∏è Sletter alle QR-koder');
                
                // Stop auto-refresh temporarily
                const wasAutoRefreshing = autoRefreshInterval !== null;
                if (wasAutoRefreshing) {
                    toggleAutoRefresh(); // Turn off
                }
                
                const response = await fetch(`${API_URL}/api/stats`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Delete all response status:', response.status);
                console.log('Delete all response ok:', response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Delete all fejl response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}\n${errorText}`);
                }

                const result = await response.json();
                console.log('‚úÖ Alle QR-koder slettet:', result);
                
                // Clear local data
                data = {};
                
                // Refresh data to update the display
                await refreshData();
                
                // Restart auto-refresh if it was on
                if (wasAutoRefreshing) {
                    setTimeout(() => toggleAutoRefresh(), 500);
                }
                
                // Show success message
                alert(`‚úÖ Alle ${qrCount} QR-koder er blevet slettet!\n\n${totalScans} scanninger er blevet mistet.`);
            } catch (error) {
                console.error('‚ùå Fejl ved sletning af alle:', error);
                console.error('Error stack:', error.stack);
                alert(`‚ùå Fejl ved sletning: ${error.message}\n\nTjek browser konsol (F12) og server konsol for detaljer.\n\nTjek ogs√• at serveren k√∏rer p√• ${API_URL}`);
            }
        }

        async function checkServerStatus() {
            console.log('üîç Tjekker server status...');
            const statusEl = document.getElementById('serverStatus');
            
            try {
                const response = await fetch(`${API_URL}/api/stats`, {
                    method: 'GET',
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    console.log('‚úÖ Server er online og svarer');
                    alert(`‚úÖ Server Status:\n\nServer er ONLINE\nURL: ${API_URL}\nStatus: ${response.status}\n\nServeren k√∏rer korrekt!`);
                } else {
                    console.warn('‚ö†Ô∏è Server svarer med fejl:', response.status);
                    alert(`‚ö†Ô∏è Server Status:\n\nServer er online men svarer med fejl\nStatus: ${response.status}\n\nTjek server konsol for detaljer.`);
                }
            } catch (error) {
                console.error('‚ùå Server er ikke tilg√¶ngelig:', error);
                alert(`‚ùå Server Status:\n\nServer er IKKE online!\n\nURL: ${API_URL}\nFejl: ${error.message}\n\nL√∏sning:\n1. √Öbn terminal/cmd\n2. Naviger til projekt mappen\n3. K√∏r: npm start\n\nServeren skal k√∏re for at dashboard'et virker!`);
            }
        }

        async function testAPI() {
            console.log('üß™ Tester API...');
            try {
                const response = await fetch(`${API_URL}/api/stats`, {
                    cache: 'no-cache'
                });
                console.log('API Response status:', response.status);
                const data = await response.json();
                console.log('API Response data:', data);
                const qrCount = Object.keys(data).length;
                let totalScans = 0;
                Object.keys(data).forEach(qrId => {
                    totalScans += data[qrId].count || 0;
                });
                console.log('Antal QR-koder i response:', qrCount);
                console.log('Total scanninger:', totalScans);
                
                // Test DELETE endpoint
                if (qrCount > 0) {
                    const firstQrId = Object.keys(data)[0];
                    console.log(`üß™ Tester DELETE endpoint med QR ID: ${firstQrId}`);
                    try {
                        const deleteTest = await fetch(`${API_URL}/api/stats/${firstQrId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        console.log('DELETE test response status:', deleteTest.status);
                        console.log('DELETE test response ok:', deleteTest.ok);
                        if (deleteTest.ok) {
                            const deleteResult = await deleteTest.json();
                            console.log('DELETE test result:', deleteResult);
                        } else {
                            const errorText = await deleteTest.text();
                            console.error('DELETE test fejl:', errorText);
                        }
                    } catch (deleteError) {
                        console.error('DELETE test fejl:', deleteError);
                    }
                }
                
                let details = `API test:\nStatus: ${response.status}\nQR-koder: ${qrCount}\nTotal scanninger: ${totalScans}\n\n`;
                if (qrCount > 0) {
                    details += 'QR-koder:\n';
                    Object.keys(data).forEach(qrId => {
                        details += `- ${qrId.substring(0, 12)}...: ${data[qrId].count} scanninger\n`;
                    });
                }
                details += '\nSe konsol for detaljer';
                alert(details);
            } catch (error) {
                console.error('API test fejl:', error);
                alert(`API test fejlede: ${error.message}\nTjek at serveren k√∏rer p√• ${API_URL}\nSe konsol for detaljer`);
            }
        }

        // Check server status on page load
        window.addEventListener('load', function() {
            // Check if server is reachable
            fetch(`${API_URL}/api/stats`)
                .then(response => {
                    if (response.ok) {
                        console.log('‚úÖ Server er online');
                    } else {
                        console.warn('‚ö†Ô∏è Server svarer med fejl:', response.status);
                    }
                })
                .catch(error => {
                    console.error('‚ùå Server er ikke tilg√¶ngelig:', error);
                    const loadingEl = document.getElementById('loading');
                    if (loadingEl) {
                        loadingEl.innerHTML = `
                            <div style="color: #dc3545; text-align: center; padding: 20px;">
                                <h3>‚ùå Server er ikke online!</h3>
                                <p>Serveren p√• ${API_URL} er ikke tilg√¶ngelig.</p>
                                <p><strong>L√∏sning:</strong></p>
                                <ol style="text-align: left; display: inline-block;">
                                    <li>√Öbn terminal/cmd</li>
                                    <li>Naviger til projekt mappen</li>
                                    <li>K√∏r: <code>npm start</code></li>
                                </ol>
                                <p style="margin-top: 20px;">
                                    <button onclick="checkServerStatus()" style="padding: 10px 20px; font-size: 16px;">
                                        üîç Tjek Server Status
                                    </button>
                                </p>
                            </div>
                        `;
                    }
                });
        });

        // Load data on page load and start auto-refresh
        loadData();
        
        // Start auto-refresh automatically when page loads
        // Use setTimeout to ensure DOM is ready
        setTimeout(function() {
            const checkbox = document.getElementById('autoRefresh');
            if (checkbox && checkbox.checked) {
                // Start auto-refresh immediately (every 3 seconds)
                autoRefreshInterval = setInterval(() => {
                    console.log('Auto-opdatering: Opdaterer data...');
                    refreshData();
                }, 3000);
                console.log('‚úÖ Auto-opdatering startet automatisk (hver 3 sek)');
            }
        }, 1000);
    </script>
</body>
</html>
